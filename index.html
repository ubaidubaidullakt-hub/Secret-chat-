<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Secret Chat üîê</title>
<style>
body {margin:0;background:#111;color:white;font-family:Arial;}
#lock {text-align:center;margin-top:30%;}
input {padding:10px;width:70%;border-radius:6px;border:none;}
button {padding:10px;margin:5px;border-radius:6px;background:#2563eb;border:none;color:white;cursor:pointer;}
.top {background:#222;padding:10px;display:flex;justify-content:space-between;}
#users {font-size:12px;padding:5px;color:#aaa;}
#messages {height:70vh;overflow-y:auto;padding:10px;}
.msg {margin:6px 0;}
.bottom {position:fixed;bottom:0;width:100%;background:#222;display:flex;}
.bottom input {flex:1;padding:10px;border-radius:6px;border:none;}
</style>
</head>
<body>

<!-- Lock screen -->
<div id="lock">
  <h2>üîê Enter Secret Key</h2>
  <input id="keyInput" placeholder="Secret key">
  <button onclick="unlock()">Unlock</button>
</div>

<!-- Chat -->
<div id="chat" hidden>
  <div class="top">
    <span id="roomName">Secret Chat</span>
    <button onclick="changeName()">‚úèÔ∏è</button>
  </div>

  <div id="users"></div>
  <div id="messages"></div>

  <div class="bottom">
    <input id="msg" placeholder="Message">
    <button onclick="send()">‚û§</button>
  </div>
</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// üî• Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBfm9sdgiWVParO8zI2gP7xATUCODCLkzw",
  authDomain: "secret-chat-2f397.firebaseapp.com",
  databaseURL: "https://secret-chat-2f397-default-rtdb.firebaseio.com",
  projectId: "secret-chat-2f397",
  storageBucket: "secret-chat-2f397.appspot.com",
  messagingSenderId: "1022707339714",
  appId: "1:1022707339714:web:e5a96bd6c899fb1c59465b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// üîê Secret key
const SECRET_KEY = "1111";

// Username
let username = localStorage.getItem("name") || prompt("Enter your name");
localStorage.setItem("name", username);

// Crypto & IDs
let cryptoKey;
let userId = Math.random().toString(36).slice(2);

// Room & references
const room = "main";
const msgRef = db.ref("rooms/" + room + "/messages");
const usersRef = db.ref("rooms/" + room + "/users");

// Add user to online list
usersRef.child(userId).set(username);
usersRef.child(userId).onDisconnect().remove();

// Show online users
usersRef.on("value", s => {
  const u = s.val() || {};
  document.getElementById("users").innerText = "Online: " + Object.values(u).join(", ");
});

// Unlock chat
async function unlock() {
  const keyInput = document.getElementById("keyInput");
  if (keyInput.value !== SECRET_KEY) { alert("Wrong key"); return; }

  cryptoKey = await crypto.subtle.importKey(
    "raw",
    new TextEncoder().encode(SECRET_KEY),
    "AES-GCM",
    false,
    ["encrypt","decrypt"]
  );

  document.getElementById("lock").hidden = true;
  document.getElementById("chat").hidden = false;
}

// Encrypt / Decrypt
async function encrypt(text) {
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const enc = await crypto.subtle.encrypt({name:"AES-GCM",iv}, cryptoKey, new TextEncoder().encode(text));
  return btoa(String.fromCharCode(...iv))+":"+btoa(String.fromCharCode(...new Uint8Array(enc)));
}

async function decrypt(data) {
  try {
    const [iv, enc] = data.split(":");
    const dec = await crypto.subtle.decrypt({name:"AES-GCM",iv:Uint8Array.from(atob(iv),c=>c.charCodeAt(0))}, cryptoKey, Uint8Array.from(atob(enc),c=>c.charCodeAt(0)));
    return new TextDecoder().decode(dec);
  } catch { return "‚ùå Encrypted"; }
}

// Load messages
msgRef.limitToLast(200).on("child_added", async snap => {
  const d = snap.val();
  const div = document.createElement("div");
  div.className = "msg";
  div.innerHTML = `<b>${d.name}</b>: ${await decrypt(d.enc)}`;
  document.getElementById("messages").appendChild(div);
});

// Send message
async function send() {
  const msg = document.getElementById("msg");
  if (!msg.value) return;
  msgRef.push({name:username,enc:await encrypt(msg.value),owner:userId,time:Date.now()});
  msg.value = "";
}

// Change name
function changeName() {
  const n = prompt("New name");
  if (n) { username=n; localStorage.setItem("name",n); usersRef.child(userId).set(n); }
}
</script>

</body>
</html>